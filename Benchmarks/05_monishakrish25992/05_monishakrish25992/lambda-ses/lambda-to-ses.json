{
   "AWSTemplateFormatVersion":"2010-09-09",
   "Description":"Lambda function to an S3 bucket using cloudformationt",
   "Parameters":{
      "BucketName":{
         "Description":"S3 bucket name for aws",
         "Type":"String",
         "Default":"lambda-s3zipfile-access"
      },
      "BucketName1":{
         "Description":"S3 bucket name for aws",
         "Type":"String",
         "Default":"lambda-s3zipfile-access"
      },
      "S3Key":{
         "Description":"S3 Object key",
         "Type":"String",
         "Default":"test"
      },
      "TopicName":{
         "Description":"SNS topic name for S3 subscription",
         "Type":"String",
         "Default":"aws-sns-topic"
      },
      "Mylambda":{
         "Description":"lambda name for aws",
         "Type":"String",
         "Default":"lambda-s3access"
      },
      "FromAddress":{
         "Description":"Email address used to send email with SES",
         "Type":"String"
      },
      "ToAddress":{
         "Description":"Email address used to receive email with SES",
         "Type":"String"
      }
   },
   "Resources":{
      "MyBucket":{
         "Type":"AWS::S3::Bucket",
         "DependsOn":"SNSTopicPolicy",
         "Properties":{
            "AccessControl":"BucketOwnerFullControl",
            "BucketName":{
               "Ref":"BucketName"
            },
            "NotificationConfiguration":{
               "TopicConfigurations":[
                  {
                     "Event":"s3:ObjectCreated:*",
                     "Topic":{
                        "Ref":"SNSTopic"
                     }
                  }
               ]
            }
         }
      },
      "SNSTopic":{
         "Type":"AWS::SNS::Topic",
         "Properties":{
            "Subscription":[
               {
                  "Endpoint":{
                     "Fn::GetAtt":[
                        "LambdaFunction",
                        "Arn"
                     ]
                  },
                  "Protocol":"lambda"
               }
            ],
            "TopicName":{
               "Ref":"TopicName"
            }
         }
      },
      "SNSTopicPolicy":{
         "Type":"AWS::SNS::TopicPolicy",
         "Properties":{
            "PolicyDocument":{
               "Id":"MyTopicPolicy",
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Principal":{
                        "Service":"s3.amazonaws.com"
                     },
                     "Action":[
                        "SNS:Publish"
                     ],
                     "Resource":"*",
                     "Condition":{
                        "ArnLike":{
                           "aws:SourceArn":{
                              "Fn::Join":[
                                 "",
                                 [
                                    "arn:aws:s3:*:*:",
                                    {
                                       "Ref":"BucketName"
                                    }
                                 ]
                              ]
                           }
                        }
                     }
                  }
               ]
            },
            "Topics":[
               {
                  "Ref":"SNSTopic"
               }
            ]
         }
      },
      "LambdaRole":{
         "Type":"AWS::IAM::Role",
         "Properties":{
            "AssumeRolePolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Principal":{
                        "Service":[
                           "lambda.amazonaws.com"
                        ]
                     },
                     "Action":[
                        "sts:AssumeRole"
                     ]
                  }
               ]
            },
            "Policies":[
               {
                  "PolicyName":"LambdaPolicy",
                  "PolicyDocument":{
                     "Version":"2012-10-17",
                     "Statement":[
                        {
                           "Effect":"Allow",
                           "Action":[
                              "logs:CreateLogGroup",
                              "logs:CreateLogStream",
                              "logs:PutLogEvents",
                              "s3:*",
                              "ses:*"
                           ],
                           "Resource":"*"
                        }
                     ]
                  }
               }
            ]
         }
      },
      "LambdaFunction":{
         "Type":"AWS::Lambda::Function",
         "Properties":{
            "Handler":"main.main",
            "Role":{
               "Fn::GetAtt":[
                  "LambdaRole",
                  "Arn"
               ]
            },
            "Code":{
               "S3Bucket":{
                  "Ref":"BucketName1"
               },
               "S3Key":{
                  "Ref":"S3Key"
               }
            },
            "Runtime":"python3.6",
            "Timeout":"30",
            "Environment":{
               "Variables":{
                  "MAIL_FROM":{
                     "Ref":"FromAddress"
                  },
                  "MAIL_TO":{
                     "Ref":"ToAddress"
                  }
               }
            }
         }
      },
      "LambdaFunctionPermission":{
         "Type":"AWS::Lambda::Permission",
         "Properties":{
            "Action":"lambda:InvokeFunction",
            "Principal":"sns.amazonaws.com",
            "SourceArn":{
               "Ref":"SNSTopic"
            },
            "FunctionName":{
               "Fn::GetAtt":[
                  "LambdaFunction",
                  "Arn"
               ]
            }
         }
      }
   }
}
